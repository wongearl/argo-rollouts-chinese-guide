本指南介绍了 Argo Rollouts 如何与AWS App Mesh管理的服务网格集成。本指南以[基本入门指南](5.1基础使用.md)的概念为基础。
# 1. 前提条件
* 安装了适用于 K8s 的 AWS App Mesh Controller 的 Kubernetes 集群
> Tip:
> 请参阅[App Mesh 控制器安装说明](https://docs.aws.amazon.com/app-mesh/latest/userguide/getting-started-kubernetes.html)，了解如何开始将 App Mesh 与 Kubernetes 结合使用。

# 2.部署Rollout, Services, App Mesh CRD
当 App Mesh 用作流量路由器时，Rollout 金丝雀策略必须定义以下必填字段：
```yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: my-rollout
spec:
  strategy:
    canary:
      # canaryService and stableService are references to Services which the Rollout will modify
      # to target the canary ReplicaSet and stable ReplicaSet respectively (required).
      canaryService: my-svc-canary
      stableService: my-svc-stable
      trafficRouting:
        appMesh:
          # The referenced virtual-service will be used to determine the virtual-router that is
          # manipulated to update canary weights.
          virtualService:
            # name of the virtual-service App Mesh CR
            name: my-svc
            # Optional set of routes to update. If empty, all routes associated with the virtual-service are updated.
            routes:
            - http-primary
          # virtualNodeGroup is a structure to refer App Mesh virtual-node CR corresponding to Canary and Stable versions
          virtualNodeGroup:
            # canaryVirtualNodeRef refers to virtual-node corresponding to canary version. Rollouts controller will
            # update the podSelector of this virtual-node to latest canary pod-hash generated by controller.
            canaryVirtualNodeRef:
              name: my-vn-canary
            # stableVirtualNodeRef refers to virtual-node corresponding to stable version. Rollouts controller will
            # update the podSelector of this virtual-node to latest stable pod-hash generated by controller.
            stableVirtualNodeRef:
              name: my-vn-stable
      steps:
      - setWeight: 25
      - pause: {}
      ...
```
在本指南中，这两项服务分别是：my-svc-canary和my-svc-stable。这些服务对应有两个虚拟节点 CR，分别名为my-vn-canary和my-vn-stable 。此外，还有一个名为rollout-demo-vsvc的虚拟服务，由名为rollout-demo-vrouter的虚拟路由器 CR 提供。该虚拟路由器需要至少有一条路由，可以将流量转发到金丝雀和稳定的虚拟节点。最初，金丝雀的权重设置为 0%，而稳定的权重设置为 100%。在rollout期间，控制器将根据 steps[N].setWeight中定义的配置修改路由的权重。

Canary 和 stable 服务被配置为无头服务。当 pod 从金丝雀重新分配到稳定版时，这是允许 App Mesh 正确处理连接池所必需的。

总而言之，运行以下命令来部署服务：
* Two services (stable and canary)
* One service (for VIP and DNS lookup)
* Two App Mesh virtual-nodes (stable and canary)
* One App Mesh virtual-router with routes to virtual-nodes
* One App Mesh virtual-service corresponding to VIP service
* A rollout
```
kubectl apply -f https://raw.githubusercontent.com/argoproj/argo-rollouts/master/examples/appmesh/canary-service.yaml
kubectl apply -f https://raw.githubusercontent.com/argoproj/argo-rollouts/master/examples/appmesh/canary-rollout.yaml
```
# 3. Verify service(验证服务)
首先确保rollout稳定。
```
kubectl argo rollouts set image my-rollout demo=argoproj/rollouts-demo:green -n argo-examples
```
然后确保service正常运行。
```
kubectl -n argo-examples port-forward svc/my-svc 8181:80
```
# 4. Rollout new version
现在是时候部署新版本了。使用新镜像更新Rollout。
```
kubectl argo rollouts set image my-rollout demo=argoproj/rollouts-demo:green -n argo-examples
```
Rollout应部署新的金丝雀修订版并更新虚拟路由器下的权重。
```
kubectl get -n argo-examples virtualrouter my-vrouter -o json | jq ".spec.routes[0].httpRoute.action.weightedTargets"
[
  {
    "virtualNodeRef": {
      "name": "my-vn-canary"
    },
    "weight": 25
  },
  {
    "virtualNodeRef": {
      "name": "my-vn-stable"
    },
    "weight": 75
  }
]
```
现在手动批准无限期暂停的rollout ，并继续观察routes 更新
```
kubectl argo rollouts promote my-rollout -n argo-examples

watch -d 'kubectl get -n argo-examples virtualrouter my-vrouter -o json | jq ".spec.routes[0].httpRoute.action.weightedTargets"'
```